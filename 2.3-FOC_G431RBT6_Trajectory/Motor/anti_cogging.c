// #include "anti_cogging.h"
#include "motor_runtime_param.h"
#include "conf.h"
#include "global_def.h"

#define point_num 1024
const float Anti_Table[point_num] = {0.258565, 0.28699, 0.29842, 0.288977, 0.273005, 0.2615, 0.256345, 0.256539, 0.259834, 0.263138, 0.263535, 0.261491, 0.257774, 0.250431, 0.235985, 0.204505, 0.15941, 0.10926, 0.060909, 0.021932, -0.008026, -0.031811, -0.05125, -0.073461, -0.108164, -0.15479, -0.219186, -0.28089, -0.328508, -0.343244, -0.332119, -0.307967, -0.285352, -0.273453, -0.273123, -0.276648, -0.277883, -0.258096, -0.205243, -0.141421, -0.096692, -0.069375, -0.046278, -0.021293, 0.007783, 0.031501, 0.047767, 0.058559, 0.065294, 0.062371, 0.057137, 0.055139, 0.049485, 0.040268, 0.030078, 0.020935, 0.011466, 0.004094, -0.001323, -0.004125, -0.003144, 0.006656, 0.022944, 0.034848, 0.034795, 0.031526, 0.032326, 0.033642, 0.031103, 0.027358, 0.025206, 0.026104, 0.023203, 0.019697, 0.026716, 0.040991, 0.053382, 0.059647, 0.056899, 0.05271, 0.056429, 0.069963, 0.083675, 0.093282, 0.103291, 0.114069, 0.124406, 0.139122, 0.153866, 0.16361, 0.16917, 0.171793, 0.17041, 0.164034, 0.161932, 0.159483, 0.146542, 0.129679, 0.112943, 0.092551, 0.066532, 0.038958, 0.013193, -0.007957, -0.025802, -0.039221, -0.051441, -0.064551, -0.082035, -0.104867, -0.139844, -0.184797, -0.240344, -0.291393, -0.318063, -0.319316, -0.304648, -0.287375, -0.275883, -0.273293, -0.274046, -0.275241, -0.274446, -0.266477, -0.243315, -0.193948, -0.145311, -0.11069, -0.090086, -0.074367, -0.058768, -0.043816, -0.022603, 0.006643, 0.043842, 0.081398, 0.117784, 0.164144, 0.213364, 0.255546, 0.278725, 0.286092, 0.286064, 0.282816, 0.276979, 0.271232, 0.270765, 0.267159, 0.257892, 0.242236, 0.225202, 0.204657, 0.17887, 0.149105, 0.124285, 0.100761, 0.070479, 0.037774, 0.011386, -0.008743, -0.023255, -0.03693, -0.046785, -0.05575, -0.063874, -0.071374, -0.081131, -0.094611, -0.110789, -0.124731, -0.135037, -0.142115, -0.148582, -0.153264, -0.155764, -0.149734, -0.13321, -0.117767, -0.103399, -0.088732, -0.077784, -0.068472, -0.055499, -0.039577, -0.020609, 0.000779, 0.022806, 0.037098, 0.048301, 0.045243, 0.028148, 0.007729, -0.009787, -0.024705, -0.038206, -0.049061, -0.060378, -0.073264, -0.089701, -0.110467, -0.13589, -0.162415, -0.184359, -0.191062, -0.182888, -0.164662, -0.130317, -0.099959, -0.076377, -0.056295, -0.027474, 0.032862, 0.107643, 0.17082, 0.21441, 0.239297, 0.242712, 0.239427, 0.242157, 0.241948, 0.22985, 0.204876, 0.182503, 0.166476, 0.152978, 0.136952, 0.117233, 0.10005, 0.083106, 0.070814, 0.06595, 0.056558, 0.047841, 0.044844, 0.052531, 0.058781, 0.054545, 0.043045, 0.032101, 0.019372, 0.006296, -0.007777, -0.022223, -0.031612, -0.037291, -0.043774, -0.048156, -0.050888, -0.054698, -0.058197, -0.060652, -0.062992, -0.066145, -0.068778, -0.070848, -0.072575, -0.075267, -0.078088, -0.07798, -0.078519, -0.080229, -0.081235, -0.08108, -0.080938, -0.079274, -0.075739, -0.072594, -0.070033, -0.068768, -0.066471, -0.064036, -0.063888, -0.063577, -0.06516, -0.066986, -0.070932, -0.075375, -0.079974, -0.083449, -0.091158, -0.10617, -0.122731, -0.1425, -0.163043, -0.176048, -0.176867, -0.168094, -0.152338, -0.129371, -0.099562, -0.070283, -0.027167, 0.068865, 0.210533, 0.311909, 0.34559, 0.316089, 0.287524, 0.274772, 0.275876, 0.281478, 0.287454, 0.290944, 0.292785, 0.294071, 0.294846, 0.294612, 0.291327, 0.284278, 0.268416, 0.232594, 0.173973, 0.117098, 0.06312, 0.018872, -0.010288, -0.029957, -0.044816, -0.058149, -0.069572, -0.082538, -0.098265, -0.113637, -0.129351, -0.147892, -0.1664, -0.183582, -0.204434, -0.228462, -0.251459, -0.274454, -0.286388, -0.288996, -0.285458, -0.277436, -0.268641, -0.260105, -0.245917, -0.231371, -0.217881, -0.187042, -0.148594, -0.110555, -0.08621, -0.06708, -0.052974, -0.035533, -0.009796, 0.039206, 0.092185, 0.145077, 0.198136, 0.238851, 0.267389, 0.276781, 0.27134, 0.262159, 0.254715, 0.246116, 0.231944, 0.204332, 0.167669, 0.125897, 0.078375, 0.032889, -0.001618, -0.027656, -0.046631, -0.062165, -0.077786, -0.092813, -0.107118, -0.12077, -0.129546, -0.134116, -0.13257, -0.117328, -0.098488, -0.07934, -0.061035, -0.028859, 0.031739, 0.099343, 0.153143, 0.186558, 0.199202, 0.198987, 0.199928, 0.190523, 0.168493, 0.135815, 0.101124, 0.071061, 0.047968, 0.027628, 0.003489, -0.015819, -0.031043, -0.042467, -0.052948, -0.060179, -0.066556, -0.071861, -0.075448, -0.078956, -0.079654, -0.082159, -0.087691, -0.091733, -0.095999, -0.100075, -0.104129, -0.11109, -0.116835, -0.126686, -0.146776, -0.16989, -0.188392, -0.201816, -0.207622, -0.20646, -0.202784, -0.198604, -0.199693, -0.1941, -0.176669, -0.156964, -0.134077, -0.108167, -0.084177, -0.058815, -0.027178, 0.023029, 0.093048, 0.180042, 0.249201, 0.291086, 0.305906, 0.299061, 0.282617, 0.272025, 0.264949, 0.259136, 0.253915, 0.248604, 0.243942, 0.240706, 0.236989, 0.227501, 0.203317, 0.161624, 0.111346, 0.064348, 0.025995, -0.001896, -0.021685, -0.038594, -0.053587, -0.06849, -0.082643, -0.0973, -0.1078, -0.11423, -0.115326, -0.107413, -0.09691, -0.088579, -0.081662, -0.076897, -0.07106, -0.067021, -0.064678, -0.062884, -0.063256, -0.064547, -0.065474, -0.067141, -0.069911, -0.073109, -0.075635, -0.080104, -0.085962, -0.094095, -0.100663, -0.108417, -0.116443, -0.121017, -0.122111, -0.119568, -0.113036, -0.104837, -0.096685, -0.090389, -0.088431, -0.085509, -0.080724, -0.077279, -0.074745, -0.072124, -0.070543, -0.068198, -0.066347, -0.063724, -0.058908, -0.052065, -0.040154, -0.019107, 0.018632, 0.069049, 0.123714, 0.170038, 0.204438, 0.234333, 0.266892, 0.291724, 0.291877, 0.276167, 0.260482, 0.251121, 0.248005, 0.25046, 0.253079, 0.254219, 0.255124, 0.254662, 0.253037, 0.245132, 0.227463, 0.201305, 0.166922, 0.121068, 0.070735, 0.029564, -0.003543, -0.02875, -0.049919, -0.072564, -0.102942, -0.144358, -0.204062, -0.268274, -0.320647, -0.346145, -0.34212, -0.320026, -0.299291, -0.285731, -0.281612, -0.286076, -0.288025, -0.283717, -0.253651, -0.188809, -0.132423, -0.095862, -0.071158, -0.049762, -0.02694, -0.004478, 0.009307, 0.019404, 0.026044, 0.029565, 0.027347, 0.024357, 0.020769, 0.014975, 0.009317, 0.00333, 0.001416, -0.000488, -0.000654, 0.001945, 0.007039, 0.017465, 0.028905, 0.037709, 0.048258, 0.057843, 0.062291, 0.061783, 0.05994, 0.057438, 0.051456, 0.040247, 0.031479, 0.027739, 0.028866, 0.029763, 0.031079, 0.039878, 0.055281, 0.071242, 0.08799, 0.103734, 0.114632, 0.123672, 0.135622, 0.149432, 0.158686, 0.159355, 0.155176, 0.153215, 0.15366, 0.158803, 0.161928, 0.160284, 0.154002, 0.145184, 0.135086, 0.127281, 0.12044, 0.107785, 0.087135, 0.065758, 0.044149, 0.018144, -0.00599, -0.02493, -0.040355, -0.053331, -0.066724, -0.083007, -0.10814, -0.144244, -0.19473, -0.247526, -0.294981, -0.31735, -0.312051, -0.294734, -0.278606, -0.26853, -0.264728, -0.266768, -0.267182, -0.263954, -0.245745, -0.204894, -0.147022, -0.108364, -0.085828, -0.071005, -0.060424, -0.053249, -0.045181, -0.030336, -0.003316, 0.032693, 0.071431, 0.120489, 0.16603, 0.206275, 0.231652, 0.246128, 0.254121, 0.256889, 0.263989, 0.274844, 0.276623, 0.266829, 0.254383, 0.242706, 0.233031, 0.216999, 0.199066, 0.175995, 0.153224, 0.118226, 0.078226, 0.038731, 0.008487, -0.013096, -0.028163, -0.04177, -0.054384, -0.064761, -0.071671, -0.077782, -0.085138, -0.096971, -0.110602, -0.124995, -0.141584, -0.151632, -0.152593, -0.152351, -0.150041, -0.146808, -0.138291, -0.119518, -0.102386, -0.08953, -0.080034, -0.070652, -0.059382, -0.048569, -0.033047, -0.014639, 0.002241, 0.011192, 0.009646, 0.001737, -0.010958, -0.023928, -0.037081, -0.048159, -0.059027, -0.067965, -0.078507, -0.090267, -0.104644, -0.121462, -0.138626, -0.154708, -0.165878, -0.175348, -0.169304, -0.143297, -0.111013, -0.087721, -0.06909, -0.042613, 0.000935, 0.063543, 0.115538, 0.16195, 0.198044, 0.215937, 0.213376, 0.202476, 0.192246, 0.179691, 0.168846, 0.158085, 0.147159, 0.135294, 0.123041, 0.109018, 0.098437, 0.095898, 0.098859, 0.097371, 0.092503, 0.09526, 0.098062, 0.094347, 0.083979, 0.076321, 0.077145, 0.072627, 0.060548, 0.043386, 0.026224, 0.00671, -0.011444, -0.021441, -0.03155, -0.03984, -0.046518, -0.053431, -0.057981, -0.061823, -0.065428, -0.066892, -0.069075, -0.072862, -0.076856, -0.081774, -0.086273, -0.091357, -0.096839, -0.098917, -0.098845, -0.097936, -0.093964, -0.090145, -0.087275, -0.08293, -0.079875, -0.075318, -0.071559, -0.069725, -0.068446, -0.067029, -0.067037, -0.067896, -0.070394, -0.073591, -0.076462, -0.081898, -0.09253, -0.105355, -0.120701, -0.135963, -0.147882, -0.149695, -0.144789, -0.129054, -0.107479, -0.089419, -0.071663, -0.038903, 0.072934, 0.243313, 0.351749, 0.34342, 0.289565, 0.261504, 0.2593, 0.266994, 0.274385, 0.277454, 0.278325, 0.278844, 0.278768, 0.279731, 0.280502, 0.279729, 0.277926, 0.270084, 0.25385, 0.216786, 0.163963, 0.099458, 0.044389, 0.001711, -0.024262, -0.044435, -0.058625, -0.068574, -0.078115, -0.090774, -0.104597, -0.11971, -0.140828, -0.163256, -0.188258, -0.215219, -0.237074, -0.25632, -0.280275, -0.298463, -0.30625, -0.302311, -0.297773, -0.294655, -0.291982, -0.285069, -0.271772, -0.246721, -0.213127, -0.178397, -0.149073, -0.119367, -0.097381, -0.078761, -0.059058, -0.030446, 0.010328, 0.061007, 0.124129, 0.179348, 0.232322, 0.265186, 0.277962, 0.273067, 0.263129, 0.255187, 0.250462, 0.23635, 0.212139, 0.174741, 0.13284, 0.086222, 0.041193, 0.003648, -0.021279, -0.039056, -0.052615, -0.067861, -0.083946, -0.099864, -0.111853, -0.113341, -0.107507, -0.09632, -0.080595, -0.068561, -0.052684, -0.025178, 0.026686, 0.091876, 0.157678, 0.205827, 0.227253, 0.226577, 0.213929, 0.195116, 0.170411, 0.138089, 0.105577, 0.078598, 0.050443, 0.024627, -0.000979, -0.018318, -0.030993, -0.041335, -0.048553, -0.05561, -0.060851, -0.064641, -0.067101, -0.068651, -0.070537, -0.073036, -0.074222, -0.077347, -0.078621, -0.083076, -0.087223, -0.091245, -0.098598, -0.112832, -0.125934, -0.14043, -0.1546, -0.169877, -0.184171, -0.193235, -0.198649, -0.198936, -0.19795, -0.191105, -0.176302, -0.153952, -0.129747, -0.104558, -0.085899, -0.069136, -0.047225, -0.00533, 0.062468, 0.146627, 0.222941, 0.272878, 0.297883, 0.298097, 0.289506, 0.276205, 0.265853, 0.259706, 0.253534, 0.247361, 0.241199, 0.235838, 0.23045, 0.220705, 0.200117, 0.160787, 0.10592, 0.049928, 0.007856, -0.021309, -0.040942, -0.056643, -0.069056, -0.079298, -0.092113, -0.105989, -0.119155, -0.125971, -0.123892, -0.116389, -0.109405, -0.100084, -0.090075, -0.080986, -0.07682, -0.073478, -0.070324, -0.068574, -0.068662, -0.069057, -0.070992, -0.072443, -0.074429, -0.078809, -0.083114, -0.087663, -0.090806, -0.095515, -0.100265, -0.103933, -0.106489, -0.112091, -0.115363, -0.113824, -0.108854, -0.102669, -0.097116, -0.093456, -0.090187, -0.08679, -0.083317, -0.080953, -0.079898, -0.07795, -0.075252, -0.073279, -0.070863, -0.067954, -0.063824, -0.058176, -0.047546, -0.032285, -0.003847, 0.035976, 0.082113, 0.133462, 0.188554, 0.231368, 0.259615};

float step = 2 * PI / (point_num - 1);

float Anti_Cogging(void)
{
    int i = encoder_angle / step;
    // if (i - 2 < 0)
    //     i += 1024;
    return Anti_Table[i] + (Anti_Table[(i + 1) % point_num] - Anti_Table[i]) * (encoder_angle / step - i);
}